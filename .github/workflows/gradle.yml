name: Java CI with Gradle

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "main" ]

# Dependency Graph 제출을 위해 전역 권한 부여
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    # 빌드 job 자체는 read면 충분하지만 전역에서 write를 이미 줬음

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle 세팅(+캐싱)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 필요에 따라 test 활성화
      - name: Build with Gradle Wrapper
        run: ./gradlew clean build -x test

      # 배포용 zip 생성
      - name: Make Directory
        run: mkdir -p deploy

      - name: Copy Jar
        run: cp ./build/libs/*.jar ./deploy

      - name: Make zip file
        shell: bash
        run: zip -r ./siso.zip ./deploy

      # AWS 자격증명은 반드시 액션으로 주입(개행/공백 문제 방지)
      - name: Configure AWS credentials (for upload & deploy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # 임시자격증명 사용 시 아래도 추가
          # aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-2

      # S3 업로드 (버킷/키 명시)
      - name: Upload bundle to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}   # 예: siso-deploy
        run: aws s3 cp ./siso.zip "s3://$S3_BUCKET_NAME/siso.zip" --region ap-northeast-2

      # CodeDeploy 배포
      - name: Deploy with CodeDeploy
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}   # 위와 동일 버킷
        run: |
          aws deploy create-deployment \
            --application-name siso \
            --deployment-group-name siso-group \
            --file-exists-behavior OVERWRITE \
            --s3-location bucket=$S3_BUCKET_NAME,bundleType=zip,key=siso.zip \
            --region ap-northeast-2

  dependency-submission:
    # push에서만 제출(포크 PR의 read-only 토큰 문제 회피)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      # Gradle 의존성 그래프 제출
      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@v4
        # 모노레포/서브폴더면 아래 주석 해제 후 경로 지정
        # with:
        #   build-root-directory: .
